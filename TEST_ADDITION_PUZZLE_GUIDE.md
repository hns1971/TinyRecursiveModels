# 测试单个加法题目指南

本指南介绍如何使用 `test_addition_puzzle.py` 脚本测试单个加法题目，查看模型的推理过程。

## 快速开始

### 基本用法

```bash
cd /root/hns/TinyRecursiveModels
conda activate trm

python test_addition_puzzle.py \
    --checkpoint checkpoints/Addition-ACT-torch/finetune_addition_step2/step_25000 \
    --num1 95817513 \
    --num2 80055143 \
    --confidence-threshold 0.95 \
    --max-steps 12
```

### 测试有进位的加法

```bash
python test_addition_puzzle.py \
    --checkpoint checkpoints/Addition-ACT-torch/finetune_addition_step1/step_30000 \
    --num1 999 \
    --num2 1 \
    --max-steps 20
```

## 参数说明

### 必需参数

- `--checkpoint`: 微调后的checkpoint路径
  - 示例: `checkpoints/Addition-ACT-torch/finetune_addition_step1/step_30000`

- `--num1`: 第一个加数
  - 示例: `123`

- `--num2`: 第二个加数
  - 示例: `456`

### 可选参数

- `--max-len`: 网格列数（默认：自动计算）
  - 如果不指定，会根据两个加数和结果的最大位数自动计算

- `--puzzle-id`: Puzzle标识符（默认：自动生成，例如 `addition_123_456`）

- `--max-steps`: 最大推理步数（默认：16）

- `--config-path`: 配置文件目录（默认：`config`）

- `--config-name`: 配置文件名（默认：`cfg_pretrain`）

## 输入格式说明

脚本会自动将两个数字转换为4行n列的网格格式：

```
示例：123 + 456 = 579

输入网格（初始状态）:
第1行（加数1）: [0, 1, 2, 3]  <- 123（右对齐）
第2行（加数2）: [0, 4, 5, 6]  <- 456（右对齐）
第3行（进位）:  [0, 0, 0, 0]  <- 初始为0
第4行（结果）:  [0, 0, 0, 0]  <- 初始为0
```

## 输出说明

脚本会显示：

1. **题目信息**:
   - 题目：`123 + 456 = 579`
   - 网格大小：`4行 × 4列`
   - 输入网格可视化

2. **推理过程**（每一步）:
   - Q_halt logit: halt的Q值
   - Halted: 是否halt
   - 每一步的预测网格（4行格式）
   - 提取的结果和期望结果的对比

3. **最终结果**:
   - 最终预测网格
   - 最终结果 vs 期望结果
   - 推理统计（总步数、Q值等）

## 示例输出

```
============================================================
加法题目测试
============================================================
题目: 123 + 456 = 579
网格大小: 4行 × 4列

输入网格（初始状态）:
--------------------------------------------------
第1行（加数1）: [0, 1, 2, 3]
第2行（加数2）: [0, 4, 5, 6]
第3行（进位）: [0, 0, 0, 0]
第4行（结果）: [0, 0, 0, 0]
--------------------------------------------------

============================================================
开始推理...
============================================================

步骤 1:
  Q_halt logit: -2.3456
  Halted: False
步骤 1 预测:
--------------------------------------------------
第1行（加数1）: [0, 1, 2, 3]
第2行（加数2）: [0, 4, 5, 6]
第3行（进位）: [0, 0, 0, 1]
第4行（结果）: [0, 0, 0, 9]
--------------------------------------------------
  提取的结果: 9 (期望: 579) ✗

步骤 2:
  Q_halt logit: -1.2345
  Halted: False
步骤 2 预测:
--------------------------------------------------
第1行（加数1）: [0, 1, 2, 3]
第2行（加数2）: [0, 4, 5, 6]
第3行（进位）: [0, 0, 1, 1]
第4行（结果）: [0, 0, 7, 9]
--------------------------------------------------
  提取的结果: 79 (期望: 579) ✗

...

最终结果:
最终预测网格:
--------------------------------------------------
第1行（加数1）: [0, 1, 2, 3]
第2行（加数2）: [0, 4, 5, 6]
第3行（进位）: [0, 0, 1, 1]
第4行（结果）: [0, 5, 7, 9]
--------------------------------------------------

最终结果: 579
期望结果: 579
是否正确: ✓ 正确
```

## 常见问题

### Q: 如何测试更大的数字？

A: 直接指定更大的数字即可，脚本会自动计算所需的网格大小：

```bash
python test_addition_puzzle.py \
    --checkpoint checkpoints/Addition-ACT-torch/finetune_addition_step1/step_30000 \
    --num1 12345 \
    --num2 67890
```

### Q: 如何查看更详细的推理过程？

A: 增加 `--max-steps` 参数：

```bash
python test_addition_puzzle.py \
    --checkpoint checkpoints/Addition-ACT-torch/finetune_addition_step1/step_30000 \
    --num1 999 \
    --num2 1 \
    --max-steps 30
```

### Q: 如果结果不正确怎么办？

A: 
1. 检查checkpoint是否正确加载
2. 确认数据集路径正确（应该是 `data/addition`）
3. 尝试增加 `--max-steps` 让模型有更多推理步数
4. 检查模型的训练是否充分

### Q: 可以直接使用test_single_puzzle.py吗？

A: `test_single_puzzle.py` 是为ARC数据集设计的，使用不同的数据格式。对于加法题目，应该使用 `test_addition_puzzle.py`。

## 使用原始test_single_puzzle.py（不推荐）

如果你一定要使用 `test_single_puzzle.py`，需要手动创建4行n列的网格：

```bash
# 示例：123 + 456
# 需要创建4行4列的网格（值范围0-9）
python test_single_puzzle.py \
    --checkpoint checkpoints/Addition-ACT-torch/finetune_addition_step1/step_30000 \
    --input "[[0,1,2,3],[0,4,5,6],[0,0,0,0],[0,0,0,0]]" \
    --puzzle-id addition_123_456
```

但这种方式需要手动计算网格大小，不推荐。

